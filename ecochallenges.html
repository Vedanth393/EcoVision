<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eco Challenges - EcoVision AI</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      background-color:#0d1b2a;min-height:100vh;color:#e0e1dd
    }
    .app-container{max-width:1400px;margin:0 auto;padding:20px}
    .header{background:#1b263b;border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 10px 20px rgba(0,0,0,.2);animation:slideDown .5s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    .header h1{font-size:2.2em;margin-bottom:8px}
    .nav-tabs{display:flex;gap:10px;margin:18px 0 26px;flex-wrap:wrap}
    .nav-tab{background:#415a77;color:#e0e1dd;text-decoration:none;border:none;padding:12px 22px;border-radius:15px;transition:.3s;display:inline-block}
    .nav-tab:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.2);background:#4c6b94}
    .nav-tab.active{background:#2e6a4d}
    .card{background:#1b263b;border-radius:20px;padding:24px;margin-bottom:20px;box-shadow:0 10px 20px rgba(0,0,0,.2);animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .challenge-item{background:#415a77;color:#e0e1dd;padding:18px;border-radius:15px;display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center;transition:.3s}
    .challenge-item:hover{transform:translateX(6px);background:#4c6b94}
    .challenge-title{font-weight:700;font-size:1.1rem}
    .progress-bar{width:100%;height:28px;background:rgba(0,0,0,.2);border-radius:14px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:#2e6a4d;border-radius:14px;transition:width .4s ease;display:flex;align-items:center;justify-content:center;color:#e0e1dd;font-size:.9em}
    .meta{opacity:.9;font-size:.95rem}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:#2e6a4d;color:#e0e1dd;border:none;padding:10px 16px;border-radius:50px;cursor:pointer;transition:.2s}
    .btn.secondary{background:#415a77}
    .btn.danger{background:#8a2e2e}
    .btn:disabled{background:#555;cursor:not-allowed}
    .points{font-size:1.1em;margin-bottom:10px;color:#2e6a4d;font-weight:700}
    .points-badge{font-weight:700;color:#d4e9dd}
    .pill{display:inline-block;background:#778da9;color:#0d1b2a;padding:10px 16px;border-radius:50px;margin:6px 6px 0 0;opacity:.6;transition:.2s;cursor:default;position:relative}
    .pill.unlocked{opacity:1;animation:shine 2s infinite}
    @keyframes shine{0%,100%{opacity:1}50%{opacity:.85}}
    .tooltip{position:absolute;left:0;bottom:115%;background:#1b263b;border:1px solid #415a77;border-radius:8px;padding:10px;width:max-content;max-width:280px;font-size:.9rem;box-shadow:0 8px 18px rgba(0,0,0,.25);display:none}
    .pill:hover .tooltip{display:block}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .tiny{font-size:.85rem;opacity:.9}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    input[type="number"],input[type="date"],select{
      background:#1b263b;border:1px solid #415a77;color:#e0e1dd;border-radius:10px;padding:8px 10px
    }
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .kbd{background:#0d1b2a;border:1px solid #415a77;border-radius:6px;padding:2px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>Eco Challenges</h1>
      <p class="tiny">Complete challenges to earn points and drive real climate impact. Log real actions â€” not clicks.</p>
    </div>

    <div class="nav-tabs">
      <a class="nav-tab" href="#">Waste Classifier</a>
      <a class="nav-tab" href="#">Carbon Tracker</a>
      <a class="nav-tab active" href="#">Eco Challenges</a>
      <a class="nav-tab" href="#">Impact Dashboard</a>
      <a class="nav-tab" href="#">Community</a>
    </div>

    <div class="flex-between">
      <div class="points">Total Points: <span id="points">0</span></div>
      <div class="actions">
        <button class="btn secondary" id="exportBtn" title="Download your progress as JSON">Export</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <button class="btn secondary" id="importBtn" title="Import progress JSON">Import</button>
        <button class="btn danger" id="resetBtn" title="Clear all local progress">Reset</button>
      </div>
    </div>

    <div class="row">
      <div class="card" id="challengesCard">
        <div class="flex-between">
          <h2>Weekly Challenges</h2>
          <span class="tiny">Tip: use <span class="kbd">Tab</span> to move fields quickly</span>
        </div>
        <div id="challenges"></div>
      </div>

      <div class="card">
        <h2>Your Achievements</h2>
        <div id="achievements"></div>
        <div class="divider"></div>
        <h2 style="margin-top:6px">Monthly Special</h2>
        <div id="monthly"></div>
      </div>
    </div>

    <div class="card" id="leaderboardCard">
      <div class="flex-between">
        <h2>Leaderboard (Mock)</h2>
        <span class="tiny">Shows how you rank vs sample users</span>
      </div>
      <table class="table" id="leaderboard"></table>
    </div>
  </div>

  <script>
    // ---------- Data Model ----------
    const initialState = {
      points: 0,
      challenges: [
        { id:1, title:"Car-Free Week", desc:"Use only sustainable transportation for 7 days", goalType:"days", goalValue:7, currentValue:0, points:50, logs:[] },
        { id:2, title:"Recycling Master", desc:"Correctly sort items", goalType:"items", goalValue:20, currentValue:0, points:30, logs:[] },
        { id:3, title:"Energy Saver", desc:"Reduce energy usage by 20%", goalType:"percent", goalValue:20, currentValue:0, points:40, logs:[] },
        { id:4, title:"Plant a Tree", desc:"Contribute to reforestation", goalType:"items", goalValue:1, currentValue:0, points:100, logs:[] },
        { id:5, title:"Water Conservation", desc:"Save 100 gallons of water this week", goalType:"gallons", goalValue:100, currentValue:0, points:60, logs:[] }
      ],
      achievements: {
        // id -> unlocked boolean
      },
      completedChallengeIds: []
    };

    const achievementCatalog = [
      { id:"first_action", name:"First Action", desc:"Log your first activity.", condition:(s)=> totalLogs(s)>0 },
      { id:"first_complete", name:"First Completion", desc:"Complete any one challenge.", condition:(s)=> s.completedChallengeIds.length>=1 },
      { id:"recycler_20", name:"Recycler 20", desc:"Recycle 20 items total.", condition:(s)=> getChallengeByTitle(s,"Recycling Master")?.currentValue>=20 },
      { id:"energy_20", name:"Energy Expert", desc:"Reach 20% energy reduction.", condition:(s)=> getChallengeByTitle(s,"Energy Saver")?.currentValue>=20 },
      { id:"two_complete", name:"Double Finish", desc:"Complete two challenges.", condition:(s)=> s.completedChallengeIds.length>=2 },
      { id:"points_200", name:"Point Sprint", desc:"Earn 200 total points.", condition:(s)=> s.points>=200 },
      { id:"streak_7", name:"Seven-Day Streak", desc:"Log car-free activity for 7 distinct days.", condition:(s)=> uniqueDates(getChallengeByTitle(s,"Car-Free Week").logs).length>=7 },
    ];

    // ---------- Persistence ----------
    const KEY="eco_vision_ai_state_v1";
    function load(){ try{ const raw=localStorage.getItem(KEY); return raw? JSON.parse(raw):structuredClone(initialState);}catch(e){return structuredClone(initialState)}}
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    // ---------- Utilities ----------
    function getChallengeById(s,id){ return s.challenges.find(c=>c.id===id); }
    function getChallengeByTitle(s,title){ return s.challenges.find(c=>c.title===title); }
    function isComplete(c){ return c.currentValue>=c.goalValue; }
    function progressPercent(c){ return Math.min(100, Math.round((c.currentValue/c.goalValue)*100)); }
    function uniqueDates(logs){ return [...new Set(logs.filter(l=>l.date).map(l=>l.date))]; }
    function totalLogs(s){ return s.challenges.reduce((n,c)=> n + c.logs.length, 0); }

    function awardPointsIfNewlyCompleted(ch){
      if(isComplete(ch) && !state.completedChallengeIds.includes(ch.id)){
        state.completedChallengeIds.push(ch.id);
        state.points += ch.points;
      }
    }

    // ---------- Monthly Special ----------
    function monthlyStatus(s){
      const now=new Date();
      const y=now.getFullYear(), m=now.getMonth();
      // complete if all weekly challenges completed with at least one log in current month
      const allComplete = s.challenges.every(c=> isComplete(c));
      const allHaveLogThisMonth = s.challenges.every(c=> c.logs.some(l=>{
        const d=new Date(l.ts||`${l.date}T00:00:00`);
        return d.getFullYear()===y && d.getMonth()===m;
      }));
      return { allComplete, allHaveLogThisMonth, completed: allComplete && allHaveLogThisMonth };
    }

    // ---------- State & Render ----------
    let state = load();

    function render(){
      renderPoints();
      renderChallenges();
      recomputeAchievements();
      renderAchievements();
      renderMonthly();
      renderLeaderboard();
      save();
    }

    function renderPoints(){ document.getElementById("points").textContent = state.points; }

    function renderChallenges(){
      const wrap=document.getElementById("challenges");
      wrap.innerHTML="";
      state.challenges.forEach(ch=>{
        const card=document.createElement("div");
        card.className="challenge-item";
        const pct=progressPercent(ch);

        const left=document.createElement("div");
        left.innerHTML=`
          <div class="challenge-title">${ch.title}</div>
          <div class="meta">${ch.desc}</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${pct}%">${ch.currentValue}/${ch.goalValue} ${ch.goalType}</div></div>
          <div class="tiny">${ch.logs.length} logs</div>
        `;

        const right=document.createElement("div");
        right.className="actions";

        // logging UI varies by goalType
        let controls="";
        if(ch.goalType==="days"){
          controls = `
            <input type="date" aria-label="Select date" value="${todayStr()}" id="date-${ch.id}"/>
            <button class="btn" data-action="log-day" data-id="${ch.id}">Log Day</button>
          `;
        } else if(ch.goalType==="percent"){
          controls = `
            <input type="number" step="0.5" min="0" max="100" placeholder="%" aria-label="Enter percent" id="val-${ch.id}" style="width:110px"/>
            <button class="btn" data-action="set-percent" data-id="${ch.id}">Set</button>
          `;
        } else {
          // items/gallons
          controls = `
            <input type="number" step="1" min="0" placeholder="Amount" aria-label="Enter amount" id="val-${ch.id}" style="width:110px"/>
            <button class="btn" data-action="add-amount" data-id="${ch.id}">Add</button>
          `;
        }

        right.innerHTML = `
          <span class="points-badge">+${ch.points} pts</span>
          ${controls}
          <button class="btn secondary" data-action="view-logs" data-id="${ch.id}">Logs</button>
          <button class="btn secondary" data-action="undo-last" data-id="${ch.id}" ${ch.logs.length===0?"disabled":""}>Undo</button>
        `;

        if(isComplete(ch)){
          // lock inputs on completion
          right.querySelectorAll("input,button[data-action]").forEach(el=>{
            if(el.dataset.action!=="view-logs"){ el.disabled=true; }
          });
        }

        card.appendChild(left);
        card.appendChild(right);
        wrap.appendChild(card);
      });

      // delegate actions
      wrap.onclick=(e)=>{
        const btn = e.target.closest("button[data-action]");
        if(!btn) return;
        const id = Number(btn.dataset.id);
        const ch = getChallengeById(state,id);
        if(!ch) return;
        const action = btn.dataset.action;

        if(action==="log-day"){
          const date = document.getElementById(`date-${id}`).value || todayStr();
          // avoid duplicate days
          const set = new Set(uniqueDates(ch.logs));
          if(set.has(date)) return toast("Already logged this date.");
          ch.logs.push({ type:"day", date, ts:Date.now(), value:1 });
          ch.currentValue = uniqueDates(ch.logs).length;
          awardPointsIfNewlyCompleted(ch);
          render();
        }

        if(action==="set-percent"){
          const val = parseFloat(document.getElementById(`val-${id}`).value);
          if(isNaN(val) || val<0 || val>100) return toast("Enter a valid percent between 0 and 100.");
          ch.logs.push({ type:"percent", value:val, ts:Date.now() });
          ch.currentValue = Math.max(ch.currentValue, val); // percent uses max achieved
          awardPointsIfNewlyCompleted(ch);
          render();
        }

        if(action==="add-amount"){
          const val = parseFloat(document.getElementById(`val-${id}`).value);
          if(isNaN(val) || val<=0) return toast("Enter a positive number.");
          ch.logs.push({ type:"amount", value:val, ts:Date.now() });
          ch.currentValue = Math.min(ch.goalValue, ch.currentValue + val);
          awardPointsIfNewlyCompleted(ch);
          render();
        }

        if(action==="undo-last"){
          const last = ch.logs.pop();
          if(!last) return;
          // recompute currentValue from logs (authoritative)
          if(ch.goalType==="days"){
            ch.currentValue = uniqueDates(ch.logs).length;
          }else if(ch.goalType==="percent"){
            ch.currentValue = ch.logs.reduce((m,l)=> l.type==="percent" ? Math.max(m,l.value) : m, 0);
          }else{
            ch.currentValue = ch.logs.reduce((sum,l)=> l.type==="amount" ? sum + l.value : sum, 0);
            ch.currentValue = Math.max(0, Math.min(ch.goalValue, ch.currentValue));
          }
          // if we undid a completion, roll back points once (only if id is still in completed list but not complete anymore)
          if(!isComplete(ch) && state.completedChallengeIds.includes(ch.id)){
            // remove id and subtract points once
            state.completedChallengeIds = state.completedChallengeIds.filter(x=>x!==ch.id);
            state.points = Math.max(0, state.points - ch.points);
          }
          render();
        }

        if(action==="view-logs"){
          const lines = ch.logs.map((l,i)=> {
            const when = l.date ? l.date : new Date(l.ts).toLocaleString();
            const val = (l.type==="percent") ? `${l.value}%` : (l.type==="amount" ? `${l.value}` : "1 day");
            return `#${i+1} â€¢ ${when} â€¢ ${l.type} â€¢ ${val}`;
          });
          alert(lines.length? lines.join("\n") : "No logs yet.");
        }
      };
    }

    function toast(msg){ console.log(msg); /* simple console toast; can be upgraded */ }

    function recomputeAchievements(){
      achievementCatalog.forEach(a=>{
        const unlocked = !!state.achievements[a.id];
        const nowUnlocked = a.condition(state);
        if(nowUnlocked && !unlocked){
          state.achievements[a.id] = true;
          // Optional: custom modal/notification
          console.log(`Unlocked: ${a.name}`);
        }
      });
    }

    function renderAchievements(){
      const wrap=document.getElementById("achievements");
      wrap.innerHTML="";
      achievementCatalog.forEach(a=>{
        const unlocked = !!state.achievements[a.id];
        const pill=document.createElement("span");
        pill.className = "pill" + (unlocked? " unlocked": "");
        pill.textContent = a.name;
        const tip=document.createElement("div");
        tip.className="tooltip";
        tip.textContent = a.desc + (unlocked? " â€¢ Unlocked":" â€¢ Locked");
        pill.appendChild(tip);
        wrap.appendChild(pill);
      });
    }

    function renderMonthly(){
      const wrap=document.getElementById("monthly");
      wrap.innerHTML="";
      const st = monthlyStatus(state);
      const pct = st.completed? 100 : Math.round(
        ( Number(st.allHaveLogThisMonth) + Number(st.allComplete) ) / 2 * 100
      );
      const bar = document.createElement("div");
      bar.className="progress-bar";
      bar.innerHTML = `<div class="progress-fill" style="width:${pct}%">${st.completed? "Completed" : (st.allComplete? "All weekly challenges complete" : "Progressing")} (${pct}%)</div>`;
      const meta = document.createElement("div");
      meta.className="tiny";
      meta.textContent = "Requirement: complete all weekly challenges and have at least one log for each during this month.";
      wrap.appendChild(bar);
      wrap.appendChild(meta);
    }

    // ---------- Leaderboard (Mock) ----------
    function renderLeaderboard(){
      const tbl = document.getElementById("leaderboard");
      const others = [
        { name:"Skyline Secondary", points: 210 },
        { name:"Green Oaks", points: 160 },
        { name:"Blue River", points: 120 }
      ];
      const you = { name:"You", points: state.points };
      const rows = [...others, you].sort((a,b)=> b.points-a.points)
        .map((r,i)=> `<tr><td style="width:70px">${i+1}</td><td>${r.name}</td><td>${r.points}</td></tr>`)
        .join("");
      tbl.innerHTML = `<thead><tr><th style="width:70px">#</th><th>Name</th><th>Points</th></tr></thead><tbody>${rows}</tbody>`;
    }

    // ---------- Helpers ----------
    function todayStr(){
      const d=new Date();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    // ---------- Export/Import/Reset ----------
    document.getElementById("resetBtn").onclick = ()=>{
      if(confirm("Reset all local progress? This cannot be undone.")){
        state = structuredClone(initialState);
        render();
      }
    };

    document.getElementById("exportBtn").onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download="eco-vision-progress.json"; a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById("importBtn").onclick = ()=>{
      document.getElementById("importFile").click();
    };
    document.getElementById("importFile").onchange = (e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          // basic shape guard
          if(!data || !Array.isArray(data.challenges)) throw new Error("Invalid data");
          state=data;
          render();
        }catch(err){ alert("Invalid JSON file."); }
      };
      reader.readAsText(f);
    };

    // ---------- Boot ----------
    render();
  </script>
</body>
</html>
