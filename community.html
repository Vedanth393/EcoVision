<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impact Dashboard - EcoVision AI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background-color:#0d1b2a;min-height:100vh;color:#e0e1dd}
    .app-container{max-width:1400px;margin:0 auto;padding:20px}
    .header{background-color:#1b263b;border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 10px 20px rgba(0,0,0,.2);animation:slideDown .5s ease;text-align:center}
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    .header h1{color:#e0e1dd;font-size:2.5em;margin-bottom:10px}
    .nav-tabs{display:flex;gap:10px;margin-bottom:30px;flex-wrap:wrap;justify-content:center}
    .nav-tab{background-color:#415a77;color:#e0e1dd;border:none;padding:15px 30px;border-radius:15px;cursor:pointer;font-size:1em;transition:all .3s ease;text-decoration:none;display:inline-block}
    .nav-tab:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.2);background-color:#4c6b94}
    .nav-tab.active{background-color:#2e6a4d}
    .card{background-color:#1b263b;border-radius:20px;padding:30px;margin-bottom:20px;box-shadow:0 10px 20px rgba(0,0,0,.2);animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
    .stat-card{background-color:#415a77;color:#e0e1dd;padding:25px;border-radius:15px;text-align:center;transition:transform .3s ease;position:relative;overflow:hidden}
    .stat-card:hover{transform:scale(1.05)}
    .stat-number{font-size:2.4em;margin:10px 0;font-weight:800}
    .chart-container{position:relative;height:400px;margin:20px 0}
    .recommendation-card{background-color:#415a77;padding:20px;border-radius:15px;margin:10px 0;color:#e0e1dd;border-left:4px solid #2e6a4d;transition:transform .3s ease}
    .recommendation-card:hover{transform:translateX(10px)}
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>Impact Dashboard</h1>
      <p>Linked to your Carbon Tracker & Eco Challenges</p>
    </div>

    <div class="nav-tabs">
      <a href="index.html" class="nav-tab">Waste Classifier</a>
      <a href="carbontracker.html" class="nav-tab">Carbon Tracker</a>
      <a href="ecochallenges.html" class="nav-tab">Eco Challenges</a>
      <a href="impactdashboard.html" class="nav-tab active">Impact Dashboard</a>
      <a href="community.html" class="nav-tab">Community</a>
    </div>


    <div class="card">
      <h2>Your Environmental Impact</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Items Recycled</h3>
          <div class="stat-number" id="stat-items">0</div>
          <p>current progress</p>
        </div>
        <div class="stat-card">
          <h3>CO₂ Saved</h3>
          <div class="stat-number" id="stat-co2">0</div>
          <p>kg (Eco + Carbon MTD)</p>
        </div>
        <div class="stat-card">
          <h3>Water Saved</h3>
          <div class="stat-number" id="stat-water">0</div>
          <p>liters</p>
        </div>
        <div class="stat-card">
          <h3>Trees Planted</h3>
          <div class="stat-number" id="stat-trees">0</div>
          <p>equivalent</p>
        </div>
        <div class="stat-card">
          <h3>Energy Saved</h3>
          <div class="stat-number" id="stat-energy">0</div>
          <p>kWh (est.)</p>
        </div>
        <div class="stat-card">
          <h3>Waste Diverted</h3>
          <div class="stat-number" id="stat-waste">0</div>
          <p>kg (est.)</p>
        </div>
      </div>
    </div>


    <div class="card">
      <h2>Impact Over Time</h2>
      <div class="chart-container">
        <canvas id="impactChart"></canvas>
      </div>
    </div>

   
    <div class="card">
      <h2>AI-Powered Recommendations</h2>
      <div id="recs"></div>
    </div>
  </div>

  <script>
  
    const ECO_KEY = 'ecoUserData_v1';
    const CT_KEY = 'carbonFootprintData';

    
    const KG_PER_ITEM = 0.25; 
    const GRID_KG_PER_KWH = 0.4; 
    const AVG_DAILY_BASELINE = 14; 

    function getMonthBounds(year, monthIndex) { 
      const start = new Date(year, monthIndex, 1);
      const end = new Date(year, monthIndex + 1, 0, 23, 59, 59, 999);
      return { start, end };
    }

    function parseStore(key, fallback){
      try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }
    }

    function sumCarbonSavingsForMonth(ctData, year, monthIndex){
      if (!ctData || !ctData.entries) return 0;
      const { start, end } = getMonthBounds(year, monthIndex);
      let sum = 0;
      for (const [date, entry] of Object.entries(ctData.entries)){
        const d = new Date(date);
        if (d >= start && d <= end){
          const total = Number(entry.total) || 0;
          const saving = Math.max(0, AVG_DAILY_BASELINE - total);
          sum += saving;
        }
      }
      return sum; 
    }

    function latestEnergyCO2(ctData){
      if (!ctData || !ctData.entries) return 0;
      let latest = null, latestDate = null;
      for (const [date, entry] of Object.entries(ctData.entries)){
        if (!latestDate || new Date(date) > latestDate){ latestDate = new Date(date); latest = entry; }
      }
      return latest ? (Number(latest.energy) || Number(latest.energyCO2) || 0) : 0; 
    }

    function loadLinkedNumbers(){
      const eco = parseStore(ECO_KEY, null);
      const ct = parseStore(CT_KEY, null);

      const now = new Date();
      const year = now.getFullYear();
      const septIndex = 8; 

      
      const itemsRecycled = eco?.challenges?.recycling?.current || 0;
      const trees = eco?.impact?.trees || 0;
      const waterGallons = eco?.impact?.water || 0;
      const waterLiters = Math.round(waterGallons * 3.785);
      const ecoCO2Saved = eco?.impact?.co2 || 0; 
      const energyReductionPct = Math.min(100, Math.max(0, eco?.challenges?.energy?.current || 0));

     
      const septCarbonSavings = sumCarbonSavingsForMonth(ct, year, septIndex); 

     
      const latestEnergyKg = latestEnergyCO2(ct);
      const latestKWh = latestEnergyKg ? (latestEnergyKg / GRID_KG_PER_KWH) : 0;
      const energySavedKWh = Math.max(0, (latestKWh * (energyReductionPct/100) * 7));

     
      const wasteKg = itemsRecycled * KG_PER_ITEM;

    
      const co2SavedCard = (ecoCO2Saved + septCarbonSavings).toFixed(1);

      return {
        itemsRecycled,
        trees,
        waterLiters,
        co2SavedCard,
        energySavedKWh: energySavedKWh.toFixed(1),
        wasteKg: wasteKg.toFixed(1),
        septCarbonSavings,
        ecoCO2Saved,
      };
    }

    function populateStats(vals){
      document.getElementById('stat-items').textContent = vals.itemsRecycled;
      document.getElementById('stat-co2').textContent = vals.co2SavedCard;
      document.getElementById('stat-water').textContent = vals.waterLiters.toLocaleString();
      document.getElementById('stat-trees').textContent = vals.trees;
      document.getElementById('stat-energy').textContent = vals.energySavedKWh;
      document.getElementById('stat-waste').textContent = vals.wasteKg;
    }

    function buildChart(vals){
      const ctx = document.getElementById('impactChart');
      if (!ctx) return;

        
      const labels = ['Aug','Sep','Oct','Nov','Dec'];
      const dataCO2 = [0, (vals.septCarbonSavings + vals.ecoCO2Saved), 0, 0, 0];
      const dataItems = [0, vals.itemsRecycled, 0, 0, 0];

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'CO₂ Saved (kg)', data: dataCO2 },
            { label: 'Items Recycled', data: dataItems }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true, grid:{color:'rgba(224,225,221,.1)'}, ticks:{ color:'#e0e1dd'} }, x:{ ticks:{ color:'#e0e1dd' }, grid:{ color:'rgba(224,225,221,.1)'} } },
          plugins:{ legend:{ labels:{ color:'#e0e1dd' } } }
        }
      });
    }

    function buildRecommendations(vals){
      const recs = [];
  
      if (vals.itemsRecycled < 10){
        recs.push({title:'Quick win: recycle 5 more items', body:'Open Eco Challenges → Recycling Master and log items as you sort. Hitting 10 will bump your CO₂ savings noticeably.'});
      } else {
        recs.push({title:'Level up recycling accuracy', body:'Target plastics #3–7 and cartons—sorting these correctly boosts avoided emissions.'});
      }

      if (Number(vals.energySavedKWh) < 5){
        recs.push({title:'Capture easy energy savings', body:'Log an energy reduction in Eco Challenges (aim +5%). Try laundry/dishwasher off‑peak and unplug idle chargers.'});
      } else {
        recs.push({title:'Keep the momentum', body:`Your estimated weekly energy saving is ~${vals.energySavedKWh} kWh. Consider a smart power strip to lock in gains.`});
      }
   
      const septSaved = (vals.septCarbonSavings + vals.ecoCO2Saved).toFixed(1);
      recs.push({title:'September focus', body:`You have ~${septSaved} kg CO₂ saved showing for September. Aim for +20% by adding two car‑free days this week.`});

      const wrap = document.getElementById('recs');
      wrap.innerHTML = recs.map(r => `
        <div class="recommendation-card">
          <h4>${r.title}</h4>
          <p>${r.body}</p>
        </div>
      `).join('');
    }

    function initPage(){
      const vals = loadLinkedNumbers();
      populateStats(vals);
      buildChart(vals);
      buildRecommendations(vals);
    }

    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
